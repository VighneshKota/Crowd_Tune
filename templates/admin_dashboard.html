<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-box {
            background-color: var(--bg-card);
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            color: var(--primary-green);
            font-weight: 700;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Admin Dashboard</h1>

        <div id="eventForm" class="card-container">
            <h2>Create Event</h2>

            <div id="errorMessage" class="error-message"></div>

            <div class="form-group">
                <label for="playlistName">Playlist Name</label>
                <input type="text" id="playlistName" placeholder="e.g., Party Hits 2024" required>
            </div>

            <div class="form-group">
                <label for="threshold">Vote Threshold</label>
                <input type="number" id="threshold" value="5" min="1" max="100" required>
                <small style="color: var(--text-secondary); display: block; margin-top: 5px;">Votes needed to add a
                    song</small>
            </div>

            <button type="button" onclick="handleCreateEvent()" style="width: 100%;">Create Event</button>
        </div>

        <div id="eventDetails" class="card-container" style="display: none;">
            <div class="success-message">âœ“ Event created successfully!</div>

            <div class="event-code" id="codeDisplay"></div>

            <div>
                <h3 style="text-align: center;">Share with Audience</h3>
                <p style="color: var(--text-secondary); text-align: center; margin-bottom: 20px;">Scan to join</p>
                <img id="qrCode" src="/placeholder.svg" alt="QR Code" class="qr-code-img">

                <div style="margin-top: 30px;">
                    <h3>Event Statistics</h3>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="statsPlaylist"></div>
                            <div class="stat-label">Playlist</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="statsThreshold"></div>
                            <div class="stat-label">Threshold</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // <CHANGE> Renamed function to avoid conflict with browser's createEvent()
        function handleCreateEvent() {
            const playlistName = document.getElementById('playlistName').value.trim();
            const threshold = document.getElementById('threshold').value;
            const errorDiv = document.getElementById('errorMessage');

            // Clear previous errors
            errorDiv.classList.remove('visible');
            errorDiv.textContent = '';

            if (!playlistName) {
                errorDiv.textContent = 'Please enter a playlist name';
                errorDiv.classList.add('visible');
                return;
            }

            console.log('[v0] Creating event with:', { playlistName, threshold });

            fetch('/api/create-event', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    playlist_name: playlistName,
                    threshold: threshold
                })
            })
                .then(r => {
                    console.log('[v0] Response status:', r.status);
                    return r.json();
                })
                .then(data => {
                    console.log('[v0] Response data:', data);
                    if (data.qr_code) {
                        console.log('[v0] QR code base64 length:', data.qr_code.length);
                        // Optionally, log a small part of the string for inspection
                        console.log('[v0] QR code base64 preview:', data.qr_code.substring(0, 50));
                    } else {
                        console.warn('[v0] No QR code received!');
                    }
                    if (data.success) {
                        document.getElementById('eventForm').style.display = 'none';
                        document.getElementById('eventDetails').style.display = 'block';
                        document.getElementById('codeDisplay').textContent = data.event_code;
                        document.getElementById('qrCode').src = 'data:image/png;base64,' + data.qr_code;
                        document.getElementById('statsPlaylist').textContent = data.playlist_name;
                        document.getElementById('statsThreshold').textContent = data.threshold + ' votes';
                    } else {
                        errorDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
                        errorDiv.classList.add('visible');
                    }
                })
                .catch(e => {
                    console.error('[v0] Fetch error:', e);
                    errorDiv.textContent = 'Error: ' + e.message;
                    errorDiv.classList.add('visible');
                });
        }
    </script>
</body>

</html>