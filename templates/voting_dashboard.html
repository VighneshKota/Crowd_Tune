<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voting Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .stats-header {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .info-box {
            background-color: #282828;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }

        .info-value {
            font-size: 1.5rem;
            color: var(--primary-green);
            font-weight: 700;
        }

        .info-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="card-container">
            <h1>ðŸŽµ Vote for Songs</h1>
            <div class="stats-header">
                <div class="info-box">
                    <div class="info-value" id="eventCode"></div>
                    <div class="info-label">Event Code</div>
                </div>
                <div class="info-box">
                    <div class="info-value" id="totalVoters">0</div>
                    <div class="info-label">Total Voters</div>
                </div>
                <div class="info-box">
                    <div class="info-value" id="votesRemaining">3</div>
                    <div class="info-label">Votes Left</div>
                </div>
            </div>
        </div>

        <div class="card-container">
            <h2>Search & Vote</h2>
            <div class="form-group" style="display: flex; gap: 10px;">
                <input type="text" id="searchInput" placeholder="Search for songs, artists...">
                <button onclick="searchSongs()" class="btn">Search</button>
            </div>
            <div id="searchError" class="error-message"
                style="display: none; color: #ff6b6b; text-align: center; margin-bottom: 1rem;"></div>
            <div id="searchLoading" class="error-message"
                style="display: none; color: var(--text-secondary); text-align: center; margin-bottom: 1rem;">
                Searching...</div>
            <div class="track-list" id="tracksList"></div>
            <div id="noResults" class="error-message"
                style="display: none; background-color: transparent; color: var(--text-secondary); text-align: center;">
                No tracks found
            </div>
        </div>

        <div class="card-container">
            <h2>Currently Voting</h2>
            <div class="track-list" id="currentTracksList"></div>
            <div id="noCurrent" class="error-message"
                style="background-color: transparent; color: var(--text-secondary); text-align: center;">No current
                votes yet</div>
        </div>
    </div>

    <script>
        const eventCode = new URLSearchParams(window.location.search).get('code') || document.location.pathname.split('/').pop();
        document.getElementById('eventCode').textContent = eventCode;

        function updateVotesRemaining(used) {
            const remaining = Math.max(0, 3 - (used || 0));
            document.getElementById('votesRemaining').textContent = remaining;
        }

        function loadEventInfo() {
            fetch(`/api/event/${eventCode}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('threshold').textContent = data.threshold;
                    document.getElementById('totalVoters').textContent = data.total_voters;
                    updateVotesRemaining(data.user_votes_used);

                    const votes = data.votes || {};
                    Object.entries(votes).forEach(([songId, count]) => {
                        document.querySelectorAll(`.vote-count-num[data-song-id="${songId}"]`).forEach(el => {
                            el.textContent = count;
                        });
                        document.querySelectorAll(`.track-item[data-song-id="${songId}"]`).forEach(trackDiv => {
                            const threshold = parseInt(document.getElementById('threshold').textContent) || 5;
                            if (count >= threshold) {
                                // trackDiv.classList.add('threshold-reached'); // Optional: Add styling
                                const info = trackDiv.querySelector('.track-info');
                                if (info && !info.querySelector('.threshold-badge')) {
                                    const m = document.createElement('span');
                                    m.className = 'threshold-badge';
                                    m.textContent = 'âœ“ ADDED';

                                    // Append to track name or separate line
                                    const nameEl = info.querySelector('.track-name');
                                    if (nameEl) nameEl.appendChild(m);
                                }
                            }
                        });
                    });
                })
                .catch(e => console.error('Error:', e));
        }

        function loadCurrentTracks() {
            fetch(`/api/event-current-tracks/${eventCode}`)
                .then(r => r.json())
                .then(data => {
                    displayCurrentTracks(data.tracks || []);
                    if (data.user_votes_used !== undefined) {
                        updateVotesRemaining(data.user_votes_used);
                    }
                })
                .catch(e => console.error('Error:', e));
        }

        function displayCurrentTracks(tracks) {
            const container = document.getElementById('currentTracksList');
            container.innerHTML = '';

            if (tracks.length === 0) {
                document.getElementById('noCurrent').style.display = 'block';
                return;
            }

            document.getElementById('noCurrent').style.display = 'none';

            tracks.forEach(track => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track-item';
                trackDiv.id = 'track-c-' + track.id;
                trackDiv.setAttribute('data-song-id', track.id);

                const voteCount = track.votes || 0;
                const threshold = parseInt(document.getElementById('threshold').textContent) || 5;
                const isThresholdReached = voteCount >= threshold || (track.is_added === true);

                trackDiv.innerHTML = `
                    <img src="${track.image}" alt="${track.name}" class="track-image">
                    <div class="track-info">
                        <div class="track-name">
                            ${track.name}
                            ${isThresholdReached ? '<span class="threshold-badge">âœ“ ADDED</span>' : ''}
                        </div>
                        <div class="track-artist">${track.artist}</div>
                    </div>
                    <div class="vote-count">
                        <span class="vote-count-num" data-song-id="${track.id}">${voteCount}</span> votes
                    </div>
                    <button class="btn vote-btn-small ${track.has_voted ? 'voted' : ''}" 
                            data-song-id="${track.id}" 
                            onclick="voteSong('${track.id}')"
                            ${isThresholdReached ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${isThresholdReached ? 'Added' : (track.has_voted ? 'Voted' : 'Vote')}
                    </button>
                `;

                container.appendChild(trackDiv);
            });
        }

        function searchSongs() {
            const query = document.getElementById('searchInput').value;
            if (!query) return;

            document.getElementById('searchError').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
            document.getElementById('searchLoading').style.display = 'block';
            document.getElementById('tracksList').innerHTML = '';

            fetch('/api/search-songs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: query })
            })
                .then(r => r.json())
                .then(data => {
                    document.getElementById('searchLoading').style.display = 'none';

                    if (data.error) {
                        const errDiv = document.getElementById('searchError');
                        errDiv.textContent = 'Search failed: ' + data.error;
                        errDiv.style.display = 'block';
                        return;
                    }
                    displayTracks(data.tracks || []);
                    if (data.user_votes_used !== undefined) {
                        updateVotesRemaining(data.user_votes_used);
                    }
                })
                .catch(e => {
                    document.getElementById('searchLoading').style.display = 'none';
                    console.error('Error:', e);
                    const errDiv = document.getElementById('searchError');
                    errDiv.textContent = 'Network or Server Error. Please try again.';
                    errDiv.style.display = 'block';
                });
        }

        function displayTracks(tracks) {
            const container = document.getElementById('tracksList');
            container.innerHTML = '';

            if (tracks.length === 0) {
                document.getElementById('noResults').style.display = 'block';
                return;
            }

            document.getElementById('noResults').style.display = 'none';

            tracks.forEach(track => {
                const trackDiv = document.createElement('div');
                trackDiv.className = 'track-item';
                trackDiv.id = 'track-s-' + track.id;
                trackDiv.setAttribute('data-song-id', track.id);

                const voteCount = track.votes || 0;
                const threshold = parseInt(document.getElementById('threshold').textContent) || 5;
                const isThresholdReached = voteCount >= threshold || (track.is_added === true);

                trackDiv.innerHTML = `
                    <img src="${track.image}" alt="${track.name}" class="track-image">
                    <div class="track-info">
                        <div class="track-name">
                            ${track.name}
                            ${isThresholdReached ? '<span class="threshold-badge">âœ“ ADDED</span>' : ''}
                        </div>
                        <div class="track-artist">${track.artist}</div>
                    </div>
                    <div class="vote-count">
                        <span class="vote-count-num" data-song-id="${track.id}">${voteCount}</span> votes
                    </div>
                    <button class="btn vote-btn-small ${track.has_voted ? 'voted' : ''}" 
                            data-song-id="${track.id}" 
                            onclick="voteSong('${track.id}')"
                            ${isThresholdReached ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                        ${isThresholdReached ? 'Added' : (track.has_voted ? 'Voted' : 'Vote')}
                    </button>
                `;

                container.appendChild(trackDiv);
            });
        }

        function voteSong(songId) {
            fetch('/api/vote', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    event_code: eventCode,
                    song_id: songId
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success === false) {
                        if (data.is_added) {
                            alert('This song has already been added to the playlist!');
                            loadCurrentTracks();
                        } else if (data.vote_limit_reached) {
                            alert('You have reached the limit of 3 votes per event!');
                        }
                        return;
                    }

                    if (data.success) {
                        if (data.user_votes_used !== undefined) {
                            updateVotesRemaining(data.user_votes_used);
                        }

                        document.querySelectorAll(`.vote-count-num[data-song-id="${songId}"]`).forEach(el => {
                            el.textContent = data.vote_count;
                        });

                        document.querySelectorAll(`.vote-btn-small[data-song-id="${songId}"]`).forEach(btn => {
                            if (data.action === 'added') {
                                btn.classList.add('voted');
                                btn.textContent = 'Voted';
                            } else {
                                btn.classList.remove('voted');
                                btn.textContent = 'Vote';
                            }
                        });

                        if (data.threshold_reached) {
                            document.querySelectorAll(`.track-item[data-song-id="${songId}"]`).forEach(trackDiv => {
                                const info = trackDiv.querySelector('.track-info');
                                if (info && !info.querySelector('.threshold-badge')) {
                                    const m = document.createElement('span');
                                    m.className = 'threshold-badge';
                                    m.textContent = 'âœ“ ADDED';
                                    const nameEl = info.querySelector('.track-name');
                                    if (nameEl) nameEl.appendChild(m);
                                }
                                const btn = trackDiv.querySelector('button');
                                if (btn) {
                                    btn.disabled = true;
                                    btn.style.opacity = '0.5';
                                    btn.style.cursor = 'not-allowed';
                                    btn.textContent = 'Added';
                                }
                            });
                        }

                        loadEventInfo();
                        loadCurrentTracks();
                    }
                })
                .catch(e => console.error('Error:', e));
        }

        document.getElementById('searchInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchSongs();
        });

        // Refresh every 2 seconds
        setInterval(() => { loadEventInfo(); loadCurrentTracks(); }, 2000);

        // Load initial info
        loadEventInfo();
        loadCurrentTracks();
    </script>
</body>

</html>